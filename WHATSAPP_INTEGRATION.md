# WhatsApp –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ CRM

–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è WhatsApp –≤ –≤–∞—à—É CRM —Å–∏—Å—Ç–µ–º—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Baileys (WhatsApp Web API).

## üì¶ –ß—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

### 1. Node.js —Å–µ—Ä–≤–∏—Å WhatsApp
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `services/whatsapp/`
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WhatsApp, –æ—Ç–ø—Ä–∞–≤–∫–∞/–ø—Ä–∏—ë–º —Å–æ–æ–±—â–µ–Ω–∏–π
- **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: Baileys, Express.js

### 2. Laravel –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏ API
- **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä**: `app/Http/Controllers/WhatsAppController.php`
- **–ú–æ–¥–µ–ª—å**: `app/Models/WhatsAppMessage.php`
- **–ú–∞—Ä—à—Ä—É—Ç—ã**: `/whatsapp/*`

### 3. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- **–°—Ç—Ä–∞–Ω–∏—Ü–∞**: `/whatsapp`
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: `resources/js/Pages/WhatsAppSettings.jsx`

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Node.js

```powershell
cd services\whatsapp
npm install
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

```powershell
cd ..\..
php artisan migrate
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ WhatsApp —Å–µ—Ä–≤–∏—Å–∞

**–í–∞—Ä–∏–∞–Ω—Ç A: –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**
```powershell
cd services\whatsapp
npm run dev
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –° pm2 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞)**
```powershell
npm install -g pm2
cd services\whatsapp
pm2 start server.js --name whatsapp-service
pm2 save
pm2 startup
```

### –®–∞–≥ 4: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WhatsApp

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://vinetkaprocrm.test/whatsapp
2. –ù–∞–∂–º–∏—Ç–µ "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å" –µ—Å–ª–∏ QR-–∫–æ–¥ –Ω–µ –ø–æ—è–≤–∏–ª—Å—è
3. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ WhatsApp:
   - WhatsApp ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (‚öôÔ∏è)
   - –°–≤—è–∑–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
   - –°–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
4. –ü–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è –Ω–∞ "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ" ‚úÖ

## üìö –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ò–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ `/whatsapp`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

### –ò–∑ –∫–æ–¥–∞ Laravel

```php
use Illuminate\Support\Facades\Http;

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
Http::post('http://localhost:3001/send-message', [
    'phone' => '79161234567',
    'message' => '–í–∞—à–∞ –∑–∞—è–≤–∫–∞ #123 –≥–æ—Ç–æ–≤–∞!'
]);

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
Http::post('http://localhost:3001/send-media', [
    'phone' => '79161234567',
    'url' => 'https://example.com/photo.jpg',
    'caption' => '–í–∞—à –≤—ã–ø—É—Å–∫–Ω–æ–π –∞–ª—å–±–æ–º',
    'type' => 'image'
]);

// –ß–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
use App\Http\Controllers\WhatsAppController;

$controller = new WhatsAppController();
$controller->notifyOrderReady(request()->merge(['order_id' => 1]));
```

### API Endpoints

| –ú–µ—Ç–æ–¥ | URL | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|-----|----------|
| GET | `/whatsapp/status` | –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ QR-–∫–æ–¥ |
| POST | `/whatsapp/send-message` | –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç |
| POST | `/whatsapp/send-media` | –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–¥–∏–∞ |
| POST | `/whatsapp/reconnect` | –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è |
| POST | `/whatsapp/disconnect` | –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è |
| POST | `/whatsapp/notify-order/{order}` | –£–≤–µ–¥–æ–º–∏—Ç—å –æ –∑–∞–∫–∞–∑–µ |

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```env
WHATSAPP_SERVICE_URL=http://localhost:3001
```

### –ü–æ—Ä—Ç Node.js —Å–µ—Ä–≤–∏—Å–∞

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `3001`

–ò–∑–º–µ–Ω–∏—Ç—å –º–æ–∂–Ω–æ –≤ `services/whatsapp/server.js`:
```javascript
const PORT = process.env.WHATSAPP_SERVICE_PORT || 3001;
```

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞

–î–æ–±–∞–≤—å—Ç–µ –≤ `OrderManagementController`:

```php
use Illuminate\Support\Facades\Http;

public function update(Request $request, Order $order)
{
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    $order->update($validated);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤
    if ($order->status === 'completed' && $order->phone) {
        Http::post(env('WHATSAPP_SERVICE_URL') . '/send-message', [
            'phone' => preg_replace('/[^0-9]/', '', $order->phone),
            'message' => "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ #{$order->id} –≥–æ—Ç–æ–≤–∞. –ú–æ–∂–µ—Ç–µ –∑–∞–±—Ä–∞—Ç—å."
        ]);
    }
    
    return redirect()->back();
}
```

### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–æ–µ–∫—Ç –∫–ª–∏–µ–Ω—Ç—É

```php
$project = Project::find(1);
$publicUrl = route('projects.public', $project->public_token);

Http::post('http://localhost:3001/send-message', [
    'phone' => $project->order->phone,
    'message' => "–í–∞—à –ø—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É: {$publicUrl}\n\n–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ —Ñ–æ—Ç–æ."
]);
```

### 3. –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞

```php
$orders = Order::where('status', 'photoshoot_scheduled')
    ->whereNotNull('phone')
    ->get();

foreach ($orders as $order) {
    Http::post('http://localhost:3001/send-message', [
        'phone' => preg_replace('/[^0-9]/', '', $order->phone),
        'message' => "–ù–∞–ø–æ–º–∏–Ω–∞–µ–º –æ —Å—ä—ë–º–∫–µ –∑–∞–≤—Ç—Ä–∞. –î–æ –≤—Å—Ç—Ä–µ—á–∏!"
    ]);
    
    sleep(2); // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
}
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–∂–Ω–æ:

1. **–ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤ Git**: –ü–∞–ø–∫–∞ `services/whatsapp/auth_state/` —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
2. **Firewall**: –ó–∞–∫—Ä–æ–π—Ç–µ –ø–æ—Ä—Ç 3001 –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
3. **Rate limiting**: –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –±–æ–ª—å—à–µ 20-30 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É
4. **–ü—Ä–æ–¥–∞–∫—à–Ω**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ nginx reverse proxy —Å HTTPS

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ pm2 –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î
- –î–æ–±–∞–≤—å—Ç–µ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```powershell
cd services\whatsapp
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Node.js 16+ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
node --version

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
rm -r node_modules
npm install
```

### QR-–∫–æ–¥ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω: `http://localhost:3001/status`
2. –ù–∞–∂–º–∏—Ç–µ "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å" –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `pm2 logs whatsapp-service`

### –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "connected"
2. –§–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞: `79161234567` (–±–µ–∑ + –∏ –ø—Ä–æ–±–µ–ª–æ–≤)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ WhatsApp
4. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –∑–∞–±–∞–Ω–µ–Ω WhatsApp

### –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `auth_state/`, –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Baileys: https://github.com/WhiskeySockets/Baileys

## üéØ Roadmap

- [ ] Webhook –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- [ ] –ì—Ä—É–ø–ø–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
